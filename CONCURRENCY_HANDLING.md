# –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ concurrency LLM API

## –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è concurrency –ª–∏–º–∏—Ç–∞ (–∫–æ–¥ 1302) –æ—Ç Z.AI API.

## –¢–∏–ø—ã –æ—à–∏–±–æ–∫ LLM

### 1. Quota Exceeded (insufficient_quota)
- **–ü—Ä–∏—á–∏–Ω–∞:** –ó–∞–∫–æ–Ω—á–∏–ª—Å—è –±–∞–ª–∞–Ω—Å –Ω–∞ —Å—á–µ—Ç–µ
- **–°—Ç–∞—Ç—É—Å:** `ERROR`
- **–î–µ–π—Å—Ç–≤–∏–µ:** –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ:** –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–æ–≤
- **–ü–æ–≤—Ç–æ—Ä—ã:** –ù–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –¥–æ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞

### 2. Concurrency Limit (–∫–æ–¥ 1302)
- **–ü—Ä–∏—á–∏–Ω–∞:** –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API
- **–°—Ç–∞—Ç—É—Å:** `RETRY`
- **–î–µ–π—Å—Ç–≤–∏–µ:** –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–º–µ—â–∞–µ—Ç—Å—è –≤ –æ—á–µ—Ä–µ–¥—å –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
- **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ:** –ê–¥–º–∏–Ω—ã –ø–æ–ª—É—á–∞—é—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (–Ω–µ —á–∞—â–µ 1 —Ä–∞–∑–∞ –≤ 5 –º–∏–Ω—É—Ç)
- **–ü–æ–≤—Ç–æ—Ä—ã:** –° exponential backoff

### 3. Generic Rate Limit
- **–ü—Ä–∏—á–∏–Ω–∞:** –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É
- **–°—Ç–∞—Ç—É—Å:** `RETRY`
- **–î–µ–π—Å—Ç–≤–∏–µ:** –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ concurrency limit
- **–ü–æ–≤—Ç–æ—Ä—ã:** –° exponential backoff

## –ú–µ—Ö–∞–Ω–∏–∑–º Retry

### Exponential Backoff

–ü—Ä–∏ –æ—à–∏–±–∫–µ concurrency/rate limit —Å–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—É—é –∑–∞–¥–µ—Ä–∂–∫—É:

| –ü–æ–ø—ã—Ç–∫–∞ | –ó–∞–¥–µ—Ä–∂–∫–∞ | –§–æ—Ä–º—É–ª–∞ |
|---------|----------|---------|
| 1       | 30 —Å–µ–∫   | 30 √ó 2^0 |
| 2       | 60 —Å–µ–∫   | 30 √ó 2^1 |
| 3       | 120 —Å–µ–∫  | 30 √ó 2^2 |
| 4       | 240 —Å–µ–∫  | 30 √ó 2^3 |
| 5+      | 480 —Å–µ–∫  | max(30 √ó 2^(n-1), 480) |

### –ü–æ–ª—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

–î–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `RETRY` –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è:
- `retry_count` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏
- `retry_after` - –≤—Ä–µ–º—è, –ø–æ—Å–ª–µ –∫–æ—Ç–æ—Ä–æ–≥–æ –º–æ–∂–Ω–æ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É

### –û–±—Ä–∞–±–æ—Ç–∫–∞ RETRY —Å–æ–æ–±—â–µ–Ω–∏–π

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `RETRY`:
1. –ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
2. –ü—Ä–∏ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–µ –∑–∞—Å—Ç—Ä—è–≤—à–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

–°–æ–æ–±—â–µ–Ω–∏–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏:
- `retry_after` –≤—Ä–µ–º—è –ø—Ä–æ—à–ª–æ
- LLM quota –Ω–µ –∏—Å—á–µ—Ä–ø–∞–Ω
- –ö–∞–Ω–∞–ª –¥–æ—Å—Ç—É–ø–µ–Ω

## –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–æ–≤

### Quota Exceeded
```
üö® –ò—Å—á–µ—Ä–ø–∞–Ω –ª–∏–º–∏—Ç LLM API!

–ù–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ù–ï –ø–∞—Ä—Å—è—Ç—Å—è

‚è∞ –í—Ä–µ–º—è: 2026-01-25 18:42:51 UTC

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –±–∞–ª–∞–Ω—Å –∏ –ø–æ–ø–æ–ª–Ω–∏—Ç–µ —Å—á–µ—Ç.
```

**–ò–Ω—Ç–µ—Ä–≤–∞–ª:** –ù–µ —á–∞—â–µ 1 —Ä–∞–∑–∞ –≤ 15 –º–∏–Ω—É—Ç

### Rate Limit / Concurrency
```
‚ö†Ô∏è –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç concurrency LLM API!

–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–º–µ–¥–ª–µ–Ω–∞

‚è∞ –í—Ä–µ–º—è: 2026-01-25 18:42:51 UTC
üîÑ –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞: 3
‚è≥ –ó–∞–¥–µ—Ä–∂–∫–∞: 120 —Å–µ–∫—É–Ω–¥

–°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π.
–≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ.

üí° –î–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è –ª–∏–º–∏—Ç–∞ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ Z.AI support.
```

**–ò–Ω—Ç–µ—Ä–≤–∞–ª:** –ù–µ —á–∞—â–µ 1 —Ä–∞–∑–∞ –≤ 5 –º–∏–Ω—É—Ç

## –õ–∏–º–∏—Ç—ã Z.AI

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤
–¢–µ–∫—É—â–∏–µ –ª–∏–º–∏—Ç—ã –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–¥–µ—Å—å: https://z.ai/manage-apikey/rate-limits

### Concurrency
- Z.AI –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ª–∏–º–∏—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ **concurrency** (–æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤)
- –õ–∏–º–∏—Ç—ã –∑–∞–≤–∏—Å—è—Ç –æ—Ç –º–æ–¥–µ–ª–∏ –∏ —Ç–∞—Ä–∏—Ñ–Ω–æ–≥–æ –ø–ª–∞–Ω–∞
- –î–ª—è GLM-4.6: –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –±–∞–ª–∞–Ω—Å–∞ –∏ —Ç–∞—Ä–∏—Ñ–∞

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
1. –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å —á–∞—Å—Ç–æ—Ç—É –æ—à–∏–±–æ–∫ concurrency
2. –ü—Ä–∏ —á–∞—Å—Ç—ã—Ö –æ—à–∏–±–∫–∞—Ö - –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –≤ Z.AI support –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è –ª–∏–º–∏—Ç–∞
3. –†–∞—Å–ø—Ä–µ–¥–µ–ª—è—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É –ø–æ –≤—Ä–µ–º–µ–Ω–∏
4. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏
–û—à–∏–±–∫–∏ concurrency –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –∫–∞–∫ `WARNING`:
```
2026-01-25 18:42:51,951 WARNING app.services.llm_service - LLM concurrency limit exceeded while parsing message 123456 (provider: zai): Error code: 429 - {'error': {'code': '1302', 'message': 'High concurrency usage of this API, please reduce concurrency or contact customer service to increase limits'}}. Will retry with backoff.
```

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `RETRY`:
```javascript
db.incoming_messages.find({
  processing_status: 'retry'
}).sort({retry_after: 1})
```

–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:
```javascript
db.incoming_messages.aggregate([
  {$match: {processing_status: 'retry'}},
  {$group: {
    _id: '$retry_count',
    count: {$sum: 1}
  }},
  {$sort: {_id: 1}}
])
```

## –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ

### –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã
- `CONCURRENCY_HANDLING.md` - —ç—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

### –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
1. `app/models/status_enums.py` - –¥–æ–±–∞–≤–ª–µ–Ω —Å—Ç–∞—Ç—É—Å `RETRY`
2. `app/models/incoming_message.py` - –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è `retry_count`, `retry_after`
3. `app/exceptions.py` - –æ–±–Ω–æ–≤–ª–µ–Ω `LLMQuotaExceededError` –¥–ª—è —Ä–∞–∑–ª–∏—á–µ–Ω–∏—è —Ç–∏–ø–æ–≤ –æ—à–∏–±–æ–∫
4. `app/services/llm_service.py`:
   - –†–∞–∑–ª–∏—á–µ–Ω–∏–µ –æ—à–∏–±–æ–∫ quota/concurrency/rate limit
   - –¢–∞–π–º–∞—É—Ç—ã –¥–ª—è API –≤—ã–∑–æ–≤–æ–≤ (60 —Å–µ–∫—É–Ω–¥)
5. `app/services/telegram_service.py`:
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –æ—à–∏–±–æ–∫ LLM
   - Exponential backoff –¥–ª—è retry
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `RETRY`
6. `app/services/admin_notification_service.py`:
   - –ú–µ—Ç–æ–¥ `notify_rate_limit_exceeded()`
   - –û—Ç–¥–µ–ª—å–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°–∏–º—É–ª—è—Ü–∏—è –æ—à–∏–±–∫–∏ concurrency
–î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–æ–∂–Ω–æ –≤—Ä–µ–º–µ–Ω–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ–¥ —Å–∏–º—É–ª—è—Ü–∏—é –æ—à–∏–±–∫–∏.

### –ü—Ä–æ–≤–µ—Ä–∫–∞ retry
1. –°–æ–∑–¥–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `RETRY`
2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `retry_after` –≤ –ø—Ä–æ—à–ª–æ–µ
3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ

## FAQ

**Q: –ß—Ç–æ –¥–µ–ª–∞—Ç—å –ø—Ä–∏ —á–∞—Å—Ç—ã—Ö –æ—à–∏–±–∫–∞—Ö concurrency?**
A: –û–±—Ä–∞—Ç–∏—Ç—å—Å—è –≤ Z.AI support –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è –ª–∏–º–∏—Ç–∞ –∏–ª–∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É.

**Q: –°–∫–æ–ª—å–∫–æ —Ä–∞–∑ —Å–∏—Å—Ç–µ–º–∞ –ø—ã—Ç–∞–µ—Ç—Å—è –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?**
A: –î–æ —Ç–µ—Ö –ø–æ—Ä, –ø–æ–∫–∞ –Ω–µ —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç –∏–ª–∏ –ø–æ–∫–∞ `retry_after` –Ω–µ –ø—Ä–µ–≤—ã—Å–∏—Ç —Ä–∞–∑—É–º–Ω—ã–π –ª–∏–º–∏—Ç (–º–∞–∫—Å–∏–º—É–º 480 —Å–µ–∫ = 8 –º–∏–Ω—É—Ç).

**Q: –ú–æ–∂–Ω–æ –ª–∏ –≤—Ä—É—á–Ω—É—é —Å–±—Ä–æ—Å–∏—Ç—å retry?**
A: –î–∞, –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ `PENDING` –∏ —É–±—Ä–∞—Ç—å `retry_count`.

**Q: –ö–∞–∫ –æ—Ç–ª–∏—á–∏—Ç—å quota –æ—Ç concurrency –≤ –ª–æ–≥–∞—Ö?**
A: Quota —Å–æ–¥–µ—Ä–∂–∏—Ç "insufficient_quota", concurrency - –∫–æ–¥ "1302" –∏–ª–∏ "high concurrency".
