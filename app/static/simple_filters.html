<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Filters - Rent No Fees Bot</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
        }

        .filter-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 6px;
            margin-bottom: 30px;
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }

        .form-group {
            flex: 1;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 5px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            /* Windows compatibility fixes */
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-color: white;
            outline: none;
            /* Ensure proper focus behavior */
            transition: border-color 0.2s ease;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            border-color: #2481cc;
            box-shadow: 0 0 0 2px rgba(36, 129, 204, 0.2);
        }

        .form-group input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
            /* Mobile compatibility */
            min-width: 20px;
            min-height: 20px;
            cursor: pointer;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            border: 2px solid #ddd;
            border-radius: 3px;
            background-color: white;
            position: relative;
        }
        
        .form-group input[type="checkbox"]:checked {
            background-color: #2481cc;
            border-color: #2481cc;
        }
        
        .form-group input[type="checkbox"]:checked::after {
            content: '‚úì';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 14px;
            font-weight: bold;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
        }
        
        .checkbox-item label {
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            padding: 5px;
            margin: 0;
            /* Make label more touch-friendly */
            min-height: 30px;
            display: flex;
            align-items: center;
        }

        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            margin-right: 0;
            white-space: nowrap;
            min-width: 70px;
            text-align: center;
        }

        .btn:hover {
            background: #0056b3;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .filters-list {
            margin-top: 30px;
        }

        .filter-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .filter-header {
            margin-bottom: 15px;
        }

        .filter-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .filter-criteria {
            color: #666;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .filter-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .status-active {
            color: #28a745;
            font-weight: 500;
        }

        .status-inactive {
            color: #dc3545;
            font-weight: 500;
        }

        .price-filters-section {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            border-left: 3px solid #007bff;
        }

        .price-filter-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            margin: 5px 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .price-filter-info {
            flex: 1;
        }

        .price-filter-actions {
            display: flex;
            gap: 5px;
        }

        .btn-info {
            background-color: #17a2b8;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .btn-info:hover {
            background-color: #138496;
        }

        .btn-sm {
            padding: 4px 8px;
            font-size: 11px;
        }

        .btn-danger-sm {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
        }

        .btn-danger-sm:hover {
            background-color: #c82333;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: black;
        }

        .form-row-3 {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .form-group-3 {
            flex: 1;
        }

        /* Price Filters Section */
        .form-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: #f8f9fa;
        }

        .form-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .form-section-header label {
            font-weight: 600;
            color: #333;
            margin: 0;
        }

        .price-filter-row {
            display: flex;
            gap: 10px;
            align-items: end;
            margin-bottom: 10px;
            padding: 10px;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
        }

        .price-filter-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        .price-filter-row .form-group label {
            font-size: 12px;
            margin-bottom: 3px;
        }

        .price-filter-row .form-group input,
        .price-filter-row .form-group select {
            padding: 4px 6px;
            font-size: 13px;
        }

        .price-filter-remove {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            height: fit-content;
        }

        .price-filter-remove:hover {
            background: #c82333;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 15px;
            }

            .form-row {
                flex-direction: column;
                gap: 10px;
            }

            .filter-name {
                font-size: 15px;
                margin-bottom: 12px;
            }

            .filter-actions {
                justify-content: center;
                margin-top: 15px;
            }

            .btn {
                flex: 1;
                min-width: 60px;
                padding: 10px 8px;
                font-size: 12px;
            }
        }

        @media (max-width: 480px) {
            .filter-actions {
                flex-direction: column;
                gap: 5px;
            }

            .btn {
                width: 100%;
                margin-bottom: 5px;
            }
        }

        .hidden {
            display: none;
        }
        
        /* Mobile-specific styles */
        @media (max-width: 768px) {
            .checkbox-item {
                min-height: 40px;
                padding: 5px 0;
            }
            
            .form-group input[type="checkbox"] {
                min-width: 24px;
                min-height: 24px;
                margin-right: 10px;
            }
            
            .checkbox-item label {
                font-size: 16px;
                min-height: 40px;
                padding: 8px;
            }
            
            .btn {
                min-height: 44px;
                font-size: 16px;
                padding: 12px 16px;
            }
            
            .form-group input,
            .form-group select {
                min-height: 32px;
                font-size: 16px;
                padding: 8px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üè† Simple Filters Management</h1>

        <!-- Main Actions -->
        <div class="main-actions" id="mainActions">
            <button class="btn btn-success" onclick="showCreateForm()">+ Create New Filter</button>
        </div>

        <!-- Filter Form (hidden by default) -->
        <div class="filter-form hidden" id="filterFormContainer">
            <h3 id="formTitle">Create New Filter</h3>
            <form id="filterForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="name">Filter Name *</label>
                        <input type="text" id="name" name="name" required autocomplete="off" spellcheck="false">
                    </div>
                    <div class="form-group">
                        <label for="description">Description</label>
                        <input type="text" id="description" name="description" autocomplete="off" spellcheck="false">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Property Types</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="apartment" name="property_types" value="apartment">
                                <label for="apartment">Apartment</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="house" name="property_types" value="house">
                                <label for="house">House</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="room" name="property_types" value="room">
                                <label for="room">Room</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="hotel_room" name="property_types" value="hotel_room">
                                <label for="hotel_room">Hotel Room</label>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Rental Types</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="long_term" name="rental_types" value="long_term">
                                <label for="long_term">Long Term</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="daily" name="rental_types" value="daily">
                                <label for="daily">Daily</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="min_rooms">Min Rooms</label>
                        <input type="number" id="min_rooms" name="min_rooms" min="1" max="10" autocomplete="off" inputmode="numeric">
                    </div>
                    <div class="form-group">
                        <label for="max_rooms">Max Rooms</label>
                        <input type="number" id="max_rooms" name="max_rooms" min="1" max="10" autocomplete="off" inputmode="numeric">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="min_area">Min Area (sqm)</label>
                        <input type="number" id="min_area" name="min_area" min="1" step="0.1" autocomplete="off" inputmode="decimal">
                    </div>
                    <div class="form-group">
                        <label for="max_area">Max Area (sqm)</label>
                        <input type="number" id="max_area" name="max_area" min="1" step="0.1" autocomplete="off" inputmode="decimal">
                    </div>
                </div>

                <!-- Price Filters Section -->
                <div class="form-section">
                    <div class="form-section-header">
                        <label>Price Filters</label>
                        <button type="button" class="btn btn-sm btn-success" onclick="addPriceFilterRow()" title="Add Price Filter">+</button>
                    </div>
                    <div id="priceFiltersContainer">
                        <!-- Price filter rows will be added here -->
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="districts">Districts (comma-separated)</label>
                        <input type="text" id="districts" name="districts" placeholder="–¶–µ–Ω—Ç—Ä, –ê—Ä–∞–±–∫–∏—Ä, –ú–∞–ª–∞—Ç–∏—è" autocomplete="off" spellcheck="false">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Features</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="has_balcony" name="has_balcony">
                                <label for="has_balcony">Balcony</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="has_air_conditioning" name="has_air_conditioning">
                                <label for="has_air_conditioning">Air Conditioning</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="has_internet" name="has_internet">
                                <label for="has_internet">Internet</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="has_furniture" name="has_furniture">
                                <label for="has_furniture">Furniture</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="has_parking" name="has_parking">
                                <label for="has_parking">Parking</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="has_garden" name="has_garden">
                                <label for="has_garden">Garden</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="has_pool" name="has_pool">
                                <label for="has_pool">Pool</label>
                            </div>
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn btn-success">Create Filter</button>
                <button type="button" class="btn" onclick="cancelEdit()" id="cancelBtn"
                    style="display: none;">Cancel</button>
            </form>
        </div>

        <div class="filters-list">
            <h3>Existing Filters</h3>
            <div id="filtersList">
                <p>Loading filters...</p>
            </div>
        </div>
    </div>


    <script>
        // Use current origin + API path
        const API_BASE = window.location.origin + '/api/v1/simple-filters';

        // Get user ID from Telegram WebApp
        let currentUserId = null;
        console.log('Telegram WebApp object:', window.Telegram);

        if (window.Telegram && window.Telegram.WebApp) {
            console.log('WebApp available:', window.Telegram.WebApp);
            console.log('initDataUnsafe:', window.Telegram.WebApp.initDataUnsafe);

            if (window.Telegram.WebApp.initDataUnsafe && window.Telegram.WebApp.initDataUnsafe.user) {
                currentUserId = window.Telegram.WebApp.initDataUnsafe.user.id;
                console.log('User ID from Telegram:', currentUserId);
            } else {
                console.log('No user data in initDataUnsafe');
            }
        } else {
            console.log('Telegram WebApp not available');
        }

        // If no user ID from Telegram, try to get from URL params
        if (!currentUserId) {
            const urlParams = new URLSearchParams(window.location.search);
            const userIdFromUrl = urlParams.get('user_id');
            console.log('User ID from URL (raw):', userIdFromUrl);
            
            if (userIdFromUrl) {
                currentUserId = parseInt(userIdFromUrl);
                console.log('User ID from URL (parsed):', currentUserId);
            } else {
                console.log('No user_id in URL params, trying to parse from hash...');
                
                // Try to parse user data from URL hash (tgWebAppData)
                const hash = window.location.hash;
                console.log('URL hash:', hash);
                
                if (hash.includes('tgWebAppData=')) {
                    try {
                        console.log('Found tgWebAppData in hash, attempting to parse...');
                        const tgWebAppData = hash.split('tgWebAppData=')[1].split('&')[0];
                        console.log('Extracted tgWebAppData:', tgWebAppData);
                        
                        const decodedData = decodeURIComponent(tgWebAppData);
                        console.log('Decoded tgWebAppData:', decodedData);
                        
                        // Parse user data from the decoded string
                        const userMatch = decodedData.match(/user%3D([^&]+)/);
                        console.log('User match result:', userMatch);
                        
                        if (userMatch) {
                            const userDataStr = decodeURIComponent(userMatch[1]);
                            console.log('User data string:', userDataStr);
                            
                            const userData = JSON.parse(userDataStr);
                            console.log('Parsed user data:', userData);
                            
                            if (userData.id) {
                                currentUserId = userData.id;
                                console.log('‚úÖ Successfully extracted User ID from hash:', currentUserId);
                            } else {
                                console.log('‚ùå No id field in user data');
                            }
                        } else {
                            console.log('‚ùå No user data found in tgWebAppData, trying alternative parsing...');
                            
                            // Alternative parsing method
                            const userMatchAlt = decodedData.match(/user=([^&]+)/);
                            console.log('Alternative user match result:', userMatchAlt);
                            
                            if (userMatchAlt) {
                                const userDataStr = decodeURIComponent(userMatchAlt[1]);
                                console.log('Alternative user data string:', userDataStr);
                                
                                const userData = JSON.parse(userDataStr);
                                console.log('Alternative parsed user data:', userData);
                                
                                if (userData.id) {
                                    currentUserId = userData.id;
                                    console.log('‚úÖ Successfully extracted User ID from alternative parsing:', currentUserId);
                                }
                            }
                        }
                    } catch (e) {
                        console.error('‚ùå Error parsing tgWebAppData:', e);
                        console.error('Error details:', e.message);
                    }
                } else {
                    console.log('‚ùå No tgWebAppData found in hash');
                }
            }
        }

        console.log('Final currentUserId:', currentUserId);
        console.log('Type of currentUserId:', typeof currentUserId);
        console.log('API_BASE:', API_BASE);

        // Check if user ID is available
        if (!currentUserId || isNaN(currentUserId)) {
            console.error('No valid user ID available! Cannot load filters.');
            console.error('Telegram WebApp available:', !!window.Telegram?.WebApp);
            console.error('initDataUnsafe available:', !!window.Telegram?.WebApp?.initDataUnsafe);
            console.error('User data available:', !!window.Telegram?.WebApp?.initDataUnsafe?.user);
            console.error('URL params:', window.location.search);
            
            // For testing purposes, show a message with instructions
            document.getElementById('filtersList').innerHTML = `
                <div style="color: orange; padding: 20px; border: 1px solid orange; border-radius: 4px; margin: 20px 0;">
                    <h3>‚ö†Ô∏è ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω</h3>
                    <p>–î–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ—Ç–∫—Ä—ã—Ç—å —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞.</p>
                    <p><strong>–î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:</strong> –î–æ–±–∞–≤—å—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä <code>?user_id=–í–ê–®_ID</code> –∫ URL</p>
                    <p><strong>–ü—Ä–∏–º–µ—Ä:</strong> <code>${window.location.origin}${window.location.pathname}?user_id=223720761</code></p>
                </div>
            `;
        }

        // Global variable to track editing filter
        let editingFilterId = null;
        let priceFilterCounter = 0;

        // Load filters on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadFilters();
            setupWindowsCompatibility();
            setupMobileCompatibility();
        });
        
        // Windows compatibility fixes
        function setupWindowsCompatibility() {
            // Ensure all input fields work properly on Windows
            document.addEventListener('input', function(e) {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') {
                    // Force re-render to fix Windows input issues
                    e.target.style.transform = 'translateZ(0)';
                }
            });
            
            // Fix focus issues on Windows
            document.addEventListener('focusin', function(e) {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') {
                    e.target.style.outline = 'none';
                    e.target.style.borderColor = '#2481cc';
                    e.target.style.boxShadow = '0 0 0 2px rgba(36, 129, 204, 0.2)';
                }
            });
            
            document.addEventListener('focusout', function(e) {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') {
                    e.target.style.borderColor = '#ddd';
                    e.target.style.boxShadow = 'none';
                }
            });
            
            // Prevent input lag on Windows
            document.addEventListener('keydown', function(e) {
                if (e.target.tagName === 'INPUT') {
                    // Clear any existing timeouts
                    if (e.target._inputTimeout) {
                        clearTimeout(e.target._inputTimeout);
                    }
                    
                    // Force immediate update
                    e.target._inputTimeout = setTimeout(function() {
                        e.target.style.transform = 'translateZ(0)';
                    }, 0);
                }
            });
        }

        // Mobile compatibility fixes for checkbox issues
        function setupMobileCompatibility() {
            // Function to setup checkbox handlers
            function setupCheckboxHandlers(checkbox) {
                // Remove existing listeners to avoid duplicates
                checkbox.removeEventListener('touchstart', handleTouchStart);
                checkbox.removeEventListener('touchend', handleTouchEnd);
                checkbox.removeEventListener('click', handleClick);
                
                // Add touch event handlers for mobile
                checkbox.addEventListener('touchstart', handleTouchStart);
                checkbox.addEventListener('touchend', handleTouchEnd);
                checkbox.addEventListener('click', handleClick);
                
                // Make checkbox more touch-friendly
                checkbox.style.minWidth = '20px';
                checkbox.style.minHeight = '20px';
                checkbox.style.cursor = 'pointer';
            }
            
            function handleTouchStart(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            function handleTouchEnd(e) {
                e.preventDefault();
                e.stopPropagation();
                
                // Toggle checkbox state
                this.checked = !this.checked;
                
                // Trigger change event
                const changeEvent = new Event('change', { bubbles: true });
                this.dispatchEvent(changeEvent);
                
                // Force visual update
                this.style.transform = 'scale(1.1)';
                setTimeout(() => {
                    this.style.transform = 'scale(1)';
                }, 100);
            }
            
            function handleClick(e) {
                // Prevent default behavior that might not work on mobile
                e.preventDefault();
                e.stopPropagation();
                
                // Toggle checkbox state
                this.checked = !this.checked;
                
                // Trigger change event
                const changeEvent = new Event('change', { bubbles: true });
                this.dispatchEvent(changeEvent);
            }
            
            // Setup initial checkboxes
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(setupCheckboxHandlers);
            
            // Setup labels
            function setupLabelHandlers(label) {
                label.removeEventListener('touchstart', handleLabelTouchStart);
                label.removeEventListener('touchend', handleLabelTouchEnd);
                
                label.addEventListener('touchstart', handleLabelTouchStart);
                label.addEventListener('touchend', handleLabelTouchEnd);
                
                label.style.cursor = 'pointer';
                label.style.userSelect = 'none';
                label.style.webkitUserSelect = 'none';
            }
            
            function handleLabelTouchStart(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            function handleLabelTouchEnd(e) {
                e.preventDefault();
                e.stopPropagation();
                
                // Find associated checkbox and toggle it
                const checkbox = document.getElementById(this.getAttribute('for'));
                if (checkbox) {
                    checkbox.checked = !checkbox.checked;
                    const changeEvent = new Event('change', { bubbles: true });
                    checkbox.dispatchEvent(changeEvent);
                }
            }
            
            const labels = document.querySelectorAll('label');
            labels.forEach(setupLabelHandlers);
            
            // Make setupCheckboxHandlers globally available for dynamic content
            window.setupCheckboxHandlers = setupCheckboxHandlers;
        }

        // Handle form submission
        document.getElementById('filterForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await saveFilter();
        });

        async function loadFilters() {
            try {
                if (!currentUserId) {
                    throw new Error('User ID not available. Please open this page from Telegram bot.');
                }

                const url = `${API_BASE}/?user_id=${currentUserId}`;
                console.log('Loading filters from URL:', url);
                console.log('Current user ID:', currentUserId);

            const response = await fetch(url);
                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const filters = await response.json();
                console.log('Loaded filters:', filters);

                const filtersList = document.getElementById('filtersList');

                if (filters.length === 0) {
                    filtersList.innerHTML = '<p>No filters created yet.</p>';
                    return;
                }

                filtersList.innerHTML = filters.map(filter => `
                    <div class="filter-item">
                        <div class="filter-header">
                            <div class="filter-name">${filter.name}</div>
                        </div>
                        <div class="filter-criteria">
                            <strong>Status:</strong> 
                            <span class="${filter.is_active ? 'status-active' : 'status-inactive'}">
                                ${filter.is_active ? 'Active' : 'Inactive'}
                            </span>
                            ${filter.description ? `<br><strong>Description:</strong> ${filter.description}` : ''}
                            ${filter.property_types.length > 0 ? `<br><strong>Property Types:</strong> ${filter.property_types.join(', ')}` : ''}
                            ${filter.rental_types.length > 0 ? `<br><strong>Rental Types:</strong> ${filter.rental_types.join(', ')}` : ''}
                            ${filter.min_rooms || filter.max_rooms ? `<br><strong>Rooms:</strong> ${filter.min_rooms || 'any'} - ${filter.max_rooms || 'any'}` : ''}
                            ${filter.min_area || filter.max_area ? `<br><strong>Area:</strong> ${filter.min_area || 'any'} - ${filter.max_area || 'any'} sqm` : ''}
                            <div id="price-filters-${filter.id}">
                                <!-- Price filters will be loaded here -->
                            </div>
                            ${filter.districts.length > 0 ? `<br><strong>Districts:</strong> ${filter.districts.join(', ')}` : ''}
                        </div>
                        <div class="filter-actions">
                            <button class="btn btn-secondary" onclick="editFilter('${filter.id}')">Edit</button>
                            <button class="btn" onclick="toggleFilter('${filter.id}')">
                                    ${filter.is_active ? 'Deactivate' : 'Activate'}
                                </button>
                            <button class="btn btn-danger" onclick="deleteFilter('${filter.id}')">Delete</button>
                        </div>
                    </div>
                `).join('');

                // Load price filters for all filters
                await loadPriceFiltersForAllFilters();

            } catch (error) {
                console.error('Error loading filters:', error);
                
                let errorMessage = error.message;
                let debugInfo = '';
                
                if (error.message.includes('User ID not available')) {
                    errorMessage = '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞.';
                    debugInfo = `
                        <p><strong>–û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</strong></p>
                        <ul>
                            <li>Telegram WebApp –¥–æ—Å—Ç—É–ø–µ–Ω: ${window.Telegram?.WebApp ? '–î–∞' : '–ù–µ—Ç'}</li>
                            <li>initDataUnsafe –¥–æ—Å—Ç—É–ø–µ–Ω: ${window.Telegram?.WebApp?.initDataUnsafe ? '–î–∞' : '–ù–µ—Ç'}</li>
                            <li>–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ—Å—Ç—É–ø–Ω—ã: ${window.Telegram?.WebApp?.initDataUnsafe?.user ? '–î–∞' : '–ù–µ—Ç'}</li>
                            <li>URL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã: ${window.location.search || '–ù–µ—Ç'}</li>
                            <li>–¢–µ–∫—É—â–∏–π URL: ${window.location.href}</li>
                        </ul>
                    `;
                }
                
                document.getElementById('filtersList').innerHTML = `
                    <div style="color: red; padding: 20px; border: 1px solid red; border-radius: 4px;">
                        <h3>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤</h3>
                        <p><strong>–û—à–∏–±–∫–∞:</strong> ${errorMessage}</p>
                        <p><strong>URL:</strong> ${API_BASE}/?user_id=${currentUserId}</p>
                        <p><strong>User ID:</strong> ${currentUserId} (—Ç–∏–ø: ${typeof currentUserId})</p>
                        <p><strong>–í—Ä–µ–º—è:</strong> ${new Date().toLocaleString('ru-RU')}</p>
                        ${debugInfo}
                        <p><strong>–†–µ—à–µ–Ω–∏–µ:</strong> –û—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É "–ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã" –≤ Telegram –±–æ—Ç–µ.</p>
                    </div>
                `;
            }
        }

        async function toggleFilter(filterId) {
            if (!currentUserId) {
                alert('User ID not available. Please open this page from Telegram bot.');
                return;
            }

            try {
            const response = await fetch(`${API_BASE}/${filterId}/toggle?user_id=${currentUserId}`, {
                method: 'POST'
            });

                if (response.ok) {
                    alert('Filter status updated!');
                    loadFilters();
                } else {
                    const error = await response.json();
                    alert('Error: ' + error.detail);
                }
            } catch (error) {
                alert('Error toggling filter: ' + error.message);
            }
        }

        async function deleteFilter(filterId) {
            if (!currentUserId) {
                alert('User ID not available. Please open this page from Telegram bot.');
                return;
            }

            if (!confirm('Are you sure you want to delete this filter?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/${filterId}?user_id=${currentUserId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('Filter deleted successfully!');
                    loadFilters();
                } else {
                    const error = await response.json();
                    alert('Error: ' + error.detail);
                }
            } catch (error) {
                alert('Error deleting filter: ' + error.message);
            }
        }

        function showCreateForm() {
            // Reset form
            document.getElementById('filterForm').reset();
            editingFilterId = null;
            clearPriceFilters();

            // Update form state
            document.getElementById('formTitle').textContent = 'Create New Filter';
            document.querySelector('button[type="submit"]').textContent = 'Create Filter';
            document.getElementById('cancelBtn').style.display = 'inline-block';

            // Show form, hide main actions
            document.getElementById('filterFormContainer').classList.remove('hidden');
            document.getElementById('mainActions').classList.add('hidden');

            // Setup mobile compatibility for all checkboxes
            if (window.setupCheckboxHandlers) {
                document.querySelectorAll('input[type="checkbox"]').forEach(window.setupCheckboxHandlers);
            }

            // Scroll to form
            document.getElementById('filterFormContainer').scrollIntoView({ behavior: 'smooth' });
        }

        async function editFilter(filterId) {
            try {
                const response = await fetch(`${API_BASE}/${filterId}`);
                if (!response.ok) throw new Error('Failed to load filter');

                const filter = await response.json();

                // Fill form with filter data
                document.getElementById('name').value = filter.name || '';
                document.getElementById('description').value = filter.description || '';
                document.getElementById('min_rooms').value = filter.min_rooms || '';
                document.getElementById('max_rooms').value = filter.max_rooms || '';
                document.getElementById('min_area').value = filter.min_area || '';
                document.getElementById('max_area').value = filter.max_area || '';
                document.getElementById('districts').value = filter.districts ? filter.districts.join(', ') : '';

                // Load price filters
                await loadPriceFiltersForEdit(filterId);

                // Set checkboxes for property types
                document.querySelectorAll('input[name="property_types"]').forEach(checkbox => {
                    checkbox.checked = filter.property_types && filter.property_types.includes(checkbox.value);
                });

                // Set checkboxes for rental types
                document.querySelectorAll('input[name="rental_types"]').forEach(checkbox => {
                    checkbox.checked = filter.rental_types && filter.rental_types.includes(checkbox.value);
                });

                // Set feature checkboxes
                document.getElementById('has_balcony').checked = filter.has_balcony === true;
                document.getElementById('has_air_conditioning').checked = filter.has_air_conditioning === true;
                document.getElementById('has_internet').checked = filter.has_internet === true;
                document.getElementById('has_furniture').checked = filter.has_furniture === true;
                document.getElementById('has_parking').checked = filter.has_parking === true;
                document.getElementById('has_garden').checked = filter.has_garden === true;
                document.getElementById('has_pool').checked = filter.has_pool === true;

                // Setup mobile compatibility for all checkboxes
                if (window.setupCheckboxHandlers) {
                    document.querySelectorAll('input[type="checkbox"]').forEach(window.setupCheckboxHandlers);
                }

                // Update form state
                editingFilterId = filterId;
                document.getElementById('formTitle').textContent = 'Edit Filter';
                document.querySelector('button[type="submit"]').textContent = 'Update Filter';
                document.getElementById('cancelBtn').style.display = 'inline-block';

                // Show form, hide main actions
                document.getElementById('filterFormContainer').classList.remove('hidden');
                document.getElementById('mainActions').classList.add('hidden');

                // Scroll to form
                document.getElementById('filterFormContainer').scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                alert('Error loading filter: ' + error.message);
            }
        }

        async function saveFilter() {
            if (!currentUserId) {
                alert('User ID not available. Please open this page from Telegram bot.');
                return;
            }

            const formData = new FormData(document.getElementById('filterForm'));
            const data = {
                name: formData.get('name'),
                description: formData.get('description'),
                property_types: formData.getAll('property_types'),
                rental_types: formData.getAll('rental_types'),
                min_rooms: formData.get('min_rooms') ? parseInt(formData.get('min_rooms')) : null,
                max_rooms: formData.get('max_rooms') ? parseInt(formData.get('max_rooms')) : null,
                min_area: formData.get('min_area') ? parseFloat(formData.get('min_area')) : null,
                max_area: formData.get('max_area') ? parseFloat(formData.get('max_area')) : null,
                districts: formData.get('districts') ? formData.get('districts').split(',').map(d => d.trim()).filter(d => d) : [],
                has_balcony: formData.get('has_balcony') === 'on' ? true : null,
                has_air_conditioning: formData.get('has_air_conditioning') === 'on' ? true : null,
                has_internet: formData.get('has_internet') === 'on' ? true : null,
                has_furniture: formData.get('has_furniture') === 'on' ? true : null,
                has_parking: formData.get('has_parking') === 'on' ? true : null,
                has_garden: formData.get('has_garden') === 'on' ? true : null,
                has_pool: formData.get('has_pool') === 'on' ? true : null
            };

            // Add user_id only for new filters
            if (!editingFilterId) {
                data.user_id = parseInt(currentUserId);
            }

            // Remove null values
            Object.keys(data).forEach(key => {
                if (data[key] === null || data[key] === undefined || data[key] === '') {
                    delete data[key];
                }
            });

            try {
                const url = editingFilterId ? `${API_BASE}/${editingFilterId}?user_id=${currentUserId}` : `${API_BASE}/`;
                const method = editingFilterId ? 'PATCH' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    const result = await response.json();
                    const filterId = editingFilterId || result.id;
                    
                    // Save price filters
                    await savePriceFilters(filterId);
                    
                    const message = editingFilterId ? 'Filter updated successfully!' : 'Filter created successfully!';
                    alert(message);

                    // Reset form and return to main view
                    cancelEdit();
                    loadFilters();
                } else {
                    const error = await response.json();
                    alert('Error: ' + error.detail);
                }
            } catch (error) {
                alert('Error saving filter: ' + error.message);
            }
        }

        function cancelEdit() {
            // Reset form
            document.getElementById('filterForm').reset();
            editingFilterId = null;
            clearPriceFilters();

            // Reset form state
            document.getElementById('formTitle').textContent = 'Create New Filter';
            document.querySelector('button[type="submit"]').textContent = 'Create Filter';
            document.getElementById('cancelBtn').style.display = 'none';

            // Hide form, show main actions
            document.getElementById('filterFormContainer').classList.add('hidden');
            document.getElementById('mainActions').classList.remove('hidden');
        }

        // Price Filter Management Functions
        function addPriceFilterRow() {
            const container = document.getElementById('priceFiltersContainer');
            const rowId = `priceFilter_${priceFilterCounter++}`;
            
            const row = document.createElement('div');
            row.className = 'price-filter-row';
            row.id = rowId;
            
            row.innerHTML = `
                <div class="form-group">
                    <label>Min Price</label>
                    <input type="number" name="price_min_${rowId}" step="0.01" min="0" placeholder="0">
                </div>
                <div class="form-group">
                    <label>Max Price</label>
                    <input type="number" name="price_max_${rowId}" step="0.01" min="0" placeholder="No limit">
                </div>
                <div class="form-group">
                    <label>Currency</label>
                    <select name="price_currency_${rowId}">
                        <option value="AMD">AMD</option>
                        <option value="USD">USD</option>
                        <option value="EUR">EUR</option>
                    </select>
                </div>
                <button type="button" class="price-filter-remove" onclick="removePriceFilterRow('${rowId}')">√ó</button>
            `;
            
            container.appendChild(row);
        }

        function removePriceFilterRow(rowId) {
            const row = document.getElementById(rowId);
            if (row) {
                row.remove();
            }
        }

        function clearPriceFilters() {
            const container = document.getElementById('priceFiltersContainer');
            container.innerHTML = '';
            priceFilterCounter = 0;
        }

        function loadPriceFiltersIntoForm(priceFilters) {
            clearPriceFilters();
            
            if (priceFilters && priceFilters.length > 0) {
                priceFilters.forEach(pf => {
                    addPriceFilterRow();
                    const rowId = `priceFilter_${priceFilterCounter - 1}`;
                    
                    const minInput = document.querySelector(`input[name="price_min_${rowId}"]`);
                    const maxInput = document.querySelector(`input[name="price_max_${rowId}"]`);
                    const currencySelect = document.querySelector(`select[name="price_currency_${rowId}"]`);
                    
                    if (minInput) minInput.value = pf.min_price || '';
                    if (maxInput) maxInput.value = pf.max_price || '';
                    if (currencySelect) currencySelect.value = pf.currency || 'AMD';
                });
            }
        }

        function getPriceFiltersFromForm() {
            const priceFilters = [];
            const rows = document.querySelectorAll('.price-filter-row');
            
            rows.forEach(row => {
                const minInput = row.querySelector('input[name^="price_min_"]');
                const maxInput = row.querySelector('input[name^="price_max_"]');
                const currencySelect = row.querySelector('select[name^="price_currency_"]');
                
                if (minInput && currencySelect) {
                    const minPrice = minInput.value && minInput.value.trim() !== '' ? parseFloat(minInput.value) : null;
                    const maxPrice = maxInput.value && maxInput.value.trim() !== '' ? parseFloat(maxInput.value) : null;
                    const currency = currencySelect.value;
                    
                    // Only add if at least min or max price is specified and both are valid numbers
                    if ((minPrice !== null && !isNaN(minPrice)) || (maxPrice !== null && !isNaN(maxPrice))) {
                        // Validate that min_price is not greater than max_price
                        if (minPrice !== null && maxPrice !== null && minPrice > maxPrice) {
                            console.warn('Skipping price filter: min_price > max_price');
                            return;
                        }
                        
                        priceFilters.push({
                            min_price: minPrice,
                            max_price: maxPrice,
                            currency: currency
                        });
                    }
                }
            });
            
            return priceFilters;
        }

        async function loadPriceFiltersForEdit(filterId) {
            try {
                const response = await fetch(`${API_BASE.replace('/simple-filters', '/price-filters')}/filters/${filterId}/price-filters`);
                const priceFilters = await response.json();
                loadPriceFiltersIntoForm(priceFilters);
            } catch (error) {
                console.error('Error loading price filters for edit:', error);
                clearPriceFilters();
            }
        }

        async function savePriceFilters(filterId) {
            try {
                console.log('Saving price filters for filter:', filterId);
                
                // First, delete existing price filters
                const existingResponse = await fetch(`${API_BASE.replace('/simple-filters', '/price-filters')}/filters/${filterId}/price-filters`);
                if (existingResponse.ok) {
                    const existingFilters = await existingResponse.json();
                    console.log('Found existing price filters:', existingFilters.length);
                    
                    for (const pf of existingFilters) {
                        console.log('Deleting price filter:', pf.id);
                        const deleteResponse = await fetch(`${API_BASE.replace('/simple-filters', '/price-filters')}/price-filters/${pf.id}`, {
                            method: 'DELETE'
                        });
                        if (!deleteResponse.ok) {
                            console.error('Failed to delete price filter:', pf.id);
                        }
                    }
                }

                // Then create new ones
                const priceFilters = getPriceFiltersFromForm();
                console.log('Creating new price filters:', priceFilters.length);
                
                for (const pf of priceFilters) {
                    console.log('Creating price filter:', pf);
                    const createResponse = await fetch(`${API_BASE.replace('/simple-filters', '/price-filters')}/price-filters`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            filter_id: filterId,
                            min_price: pf.min_price,
                            max_price: pf.max_price,
                            currency: pf.currency,
                            is_active: true
                        })
                    });
                    
                    if (!createResponse.ok) {
                        console.error('Failed to create price filter:', pf);
                    }
                }
            } catch (error) {
                console.error('Error saving price filters:', error);
            }
        }

        // Load price filters for each filter when main filters are loaded
        async function loadPriceFiltersForAllFilters() {
            const filterItems = document.querySelectorAll('.filter-item');
            for (const item of filterItems) {
                const filterId = item.querySelector('[onclick*="editFilter"]').onclick.toString().match(/'([^']+)'/)[1];
                const priceFiltersDiv = document.getElementById(`price-filters-${filterId}`);
                
                try {
                    const response = await fetch(`${API_BASE.replace('/simple-filters', '/price-filters')}/filters/${filterId}/price-filters`);
                    const priceFilters = await response.json();
                    
                    if (priceFilters.length > 0) {
                        priceFiltersDiv.innerHTML = `
                            <br><strong>Price Filters:</strong> 
                            ${priceFilters.map(pf => 
                                `${pf.currency}: ${pf.min_price ? pf.min_price.toLocaleString() : 'any'} - ${pf.max_price ? pf.max_price.toLocaleString() : 'any'}`
                            ).join(', ')}
                        `;
                    }
                } catch (error) {
                    console.error(`Error loading price filters for filter ${filterId}:`, error);
                }
            }
        }
    </script>
</body>

</html>